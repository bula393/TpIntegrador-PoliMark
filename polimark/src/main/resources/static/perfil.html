<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PoliMark - Perfil</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        /* --- VARIABLES Y RESET (Igual que p√°g 5 para consistencia) --- */
        :root {
            --primary-red: #b71c1c;
            --primary-red-hover: #9f1616;
            --bg-black: #000000;
            --bg-panel: #121212; /* Gris muy oscuro del panel */
            --text-white: #ffffff;
            --text-gray: #a0a0a0;
            --input-border: #555;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', sans-serif; }
        body { background-color: var(--bg-black); color: var(--text-white); }
        a { text-decoration: none; color: inherit; }
        ul { list-style: none; }

        /* --- HEADER --- */
        header {
            background-color: var(--primary-red);
            padding: 15px 50px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .logo { font-weight: bold; font-size: 1.2rem; display: flex; align-items: center; gap: 10px; }
        .logoImagen { width : 50px }
        nav ul { display: flex; gap: 20px; font-size: 0.9rem; }
        .login-btn { background-color: black; padding: 8px 20px; border-radius: 4px; font-weight: bold; }

        /* --- MAIN LAYOUT --- */
        .main-container {
            display: flex;
            justify-content: center;
            align-items: center; /* Centrado vertical visual */
            min-height: 80vh; /* Ocupa gran parte de la pantalla */
            padding: 40px 20px;
            flex-direction: column;
        }

        /* --- PROFILE BOX --- */
        .profile-card {
            background-color: var(--bg-panel);
            width: 100%;
            max-width: 900px;
            border-radius: 10px;
            padding: 40px;
            position: relative;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }

        .profile-title {
            text-align: center;
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 40px;
        }

        .profile-content {
            display: flex;
            gap: 50px;
            align-items: flex-start;
        }

        /* Avatar Section (Izquierda) */
        .avatar-section {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 30%;
        }

        .avatar-circle {
            width: 150px;
            height: 150px;
            background-color: #333;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            border: 2px solid #555;
            margin-bottom: 20px;
        }
        .avatar-circle i { font-size: 80px; color: #888; }

        .username-display {
            font-size: 1.5rem;
            font-weight: bold;
            text-align: center;
        }

        /* Form Section (Centro/Derecha) */
        .form-section {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 20px;
            position: relative;
        }

        .input-group {
            display: flex;
            flex-direction: column;
        }

        .input-field {
            background-color: transparent;
            border: 1px solid var(--text-white);
            color: white;
            padding: 12px;
            border-radius: 4px;
            font-size: 1rem;
        }
        .input-field::placeholder { color: #666; }

        .rank-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .rank-label {
            font-size: 1.5rem;
            font-weight: bold;
            text-transform: lowercase; /* "rango" en el pdf */
        }

        .rank-value {
            font-size: 1.2rem;
            color: var(--text-gray);
            margin-right: auto;
            margin-left: 15px;
            text-transform: capitalize;
        }

        .action-btn {
            background-color: var(--primary-red);
            color: white;
            border: none;
            padding: 12px;
            border-radius: 5px;
            font-weight: bold;
            font-size: 1rem;
            cursor: pointer;
            transition: background 0.3s;
            text-align: center;
            width: 100%;
        }
        .action-btn:hover { background-color: var(--primary-red-hover); }

        /* Bot√≥n cuadrado "SUBIR RANGO" */
        .rank-up-btn {
            background-color: var(--primary-red);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 15px;
            font-weight: bold;
            text-align: center;
            cursor: pointer;
            position: absolute;
            right: 0;
            top: 57px; /* Ajustado visualmente */
            width: 100px;
            line-height: 1.2;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }
        .rank-up-btn:hover { background-color: var(--primary-red-hover); }

        /* Bot√≥n Historial (Largo abajo) */
        .history-btn-container {
            margin-top: 40px;
            width: 100%;
        }
        .history-btn {
            width: 100%;
            background-color: var(--primary-red);
            color: white;
            padding: 15px;
            font-size: 1.1rem;
            font-weight: bold;
            border: none;
            border-radius: 8px;
            cursor: pointer;
        }

        /* --- HISTORIAL EXPANDIBLE --- */
        #historial-container {
            display: none; /* Oculto por defecto */
            margin-top: 20px;
            background-color: #1a1a1a;
            padding: 20px;
            border-radius: 8px;
            width: 100%;
            border-top: 1px solid #333;
        }

        .ticket-card {
            display: flex;
            justify-content: space-between;
            background-color: #2a2a2a;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 5px;
            border-left: 4px solid var(--primary-red);
            align-items: center;
        }

        .ticket-info h4 { font-size: 1.1rem; margin-bottom: 5px; color: white; }
        .ticket-meta { font-size: 0.9rem; color: #ccc; }
        .ticket-price { font-size: 1.2rem; font-weight: bold; color: var(--primary-red); }

        /* --- FOOTER --- */
        footer {
            background-color: #1a1a1a;
            padding: 50px;
            font-size: 0.8rem;
            color: var(--text-gray);
            border-top: 1px solid #333;
            display: flex;
            justify-content: space-between;
        }

        .footer-links {
            display: flex;
            gap: 80px;
        }

        .footer-col h4 {
            color: white;
            margin-bottom: 15px;
        }

        .footer-col ul li {
            margin-bottom: 8px;
        }
        /* =========================================================
   ===============   RESPONSIVE DESIGN   ====================
   ========================================================= */

/* üîπ Tablets ‚Äî 900px para abajo */
@media (max-width: 900px) {

    header {
        padding: 15px 25px;
    }

    nav ul {
        gap: 10px;
        font-size: 0.8rem;
    }

    .profile-card {
        padding: 30px;
    }

    .profile-content {
        gap: 25px;
    }

    /* Avatar m√°s chico */
    .avatar-section {
        width: 35%;
    }

    .avatar-circle {
        width: 130px;
        height: 130px;
    }

    /* Bot√≥n subir rango reposicionado */
    .rank-up-btn {
        top: 40px;
        right: 0;
        width: 90px;
        padding: 12px;
        font-size: 0.85rem;
    }

    /* Footer m√°s compacto */
    footer {
        flex-direction: column;
        gap: 40px;
        text-align: center;
    }

    .footer-links {
        justify-content: center;
        gap: 40px;
    }
}

/* üîπ Celulares grandes ‚Äî 768px para abajo */
@media (max-width: 768px) {

    header {
        flex-direction: column;
        gap: 10px;
        padding: 15px 15px;
    }

    nav ul {
        gap: 15px;
    }

    /* El contenido del perfil pasa a columna */
    .profile-content {
        flex-direction: column;
        align-items: center;
        gap: 35px;
    }

    .avatar-section {
        width: 100%;
    }

    /* Form a ancho completo */
    .form-section {
        width: 100%;
    }

    /* Bot√≥n SUBIR RANGO pasa abajo del rango */
    .rank-up-btn {
        position: relative;
        top: 0;
        right: 0;
        margin-top: 10px;
        width: 100%;
    }

    .rank-row {
        flex-direction: column;
        align-items: flex-start;
        gap: 5px;
    }

    footer {
        padding: 40px 20px;
    }

    .footer-links {
        flex-direction: column;
        gap: 30px;
    }
}

/* üîπ Celulares chicos ‚Äî 480px para abajo */
@media (max-width: 480px) {

    header {
        padding: 10px;
    }

    .logoImagen {
        width: 40px;
    }

    nav ul {
        font-size: 0.75rem;
        gap: 10px;
    }

    .profile-title {
        font-size: 1.5rem;
    }

    .avatar-circle {
        width: 110px;
        height: 110px;
    }

    .username-display {
        font-size: 1.2rem;
    }

    .profile-card {
        padding: 20px;
    }

    /* Ticket del historial */
    .ticket-card {
        flex-direction: column;
        gap: 10px;
        text-align: center;
    }

    .ticket-price {
        font-size: 1.1rem;
    }

    footer {
        font-size: 0.75rem;
    }
}

    </style>
</head>
<body>

<!-- Header -->
<header>
    <a href="index.html">
        <div class="logo">
            <img class="logoImagen" src="imagenes/logo.png"></img> PoliMark
        </div>
    </a>
    <nav>
        <ul>
            <li><a href="#">Movies</a></li>
            <li><a href="#">About</a></li>
            <li><a href="#">Blog</a></li>
            <li><a href="#">Help</a></li>
        </ul>
    </nav>
    <a href="#" class="login-btn">Login</a>
</header>

<div class="main-container">
    <div class="profile-card">
        <h2 class="profile-title">Informacion Personal</h2>

        <div class="profile-content">
            <!-- Columna Izquierda: Avatar -->
            <div class="avatar-section">
                <div class="avatar-circle">
                    <i class="fas fa-user"></i>
                </div>
                <div class="username-display" id="username-display">
                    Cargando...
                </div>
            </div>

            <!-- Columna Derecha: Formulario -->
            <div class="form-section">
                <!-- Bot√≥n flotante Subir Rango -->
                <button class="rank-up-btn">SUBIR<br>RANGO</button>

                <!-- Email -->
                <div class="input-group">
                    <input type="email" id="email-input" class="input-field" placeholder="Gmail" readonly>
                </div>

                <!-- Rango Texto -->
                <div class="rank-row">
                    <span class="rank-label">rango</span>
                    <span class="rank-value" id="rank-display">...</span>
                </div>

                <!-- Botones Acciones -->
                <button class="action-btn" style="margin-bottom: 10px;">Cambiar mail</button>
                <button class="action-btn">Cambiar contrase√±a</button>
            </div>
        </div>

        <!-- Bot√≥n Historial -->
        <div class="history-btn-container">
            <button class="history-btn" id="toggle-history-btn">Ver historial de entradas</button>
        </div>

        <!-- Contenedor Oculto del Historial -->
        <div id="historial-container">
            <!-- Aqu√≠ se inyectan las entradas -->
            <p style="text-align: center; color: #888;">Cargando historial...</p>
        </div>
    </div>
</div>

<!-- Footer -->
<footer>
    <div>
        <a href="index.html">
            <div class="logo" style="margin-bottom: 20px;">
                <img class="logoImagen" src="imagenes/logo.png"></img> PoliMark
            </div>
        </a>
        <div class="socials">
            <i class="fab fa-facebook"></i>
            <i class="fab fa-instagram"></i>
            <i class="fab fa-twitter"></i>
            <i class="fab fa-youtube"></i>
        </div>
        <p style="margin-top: 20px;">All rights reserved ¬© 2025 PoliMark</p>
    </div>

    <div class="footer-links">
        <div class="footer-col">
            <h4>Movies</h4>
            <ul>
                <li>Now</li>
                <li>Upcoming</li>
                <li>Classics</li>
            </ul>
        </div>
        <div class="footer-col">
            <h4>Snacks</h4>
            <ul>
                <li>Popcorn</li>
                <li>Drinks</li>
                <li>Combos</li>
            </ul>
        </div>
        <div class="footer-col">
            <h4>Visit</h4>
            <ul>
                <li>Map</li>
                <li>Contact</li>
                <li>FAQ</li>
            </ul>
        </div>
    </div>
</footer>

<!-- JAVASCRIPT -->
<script>
    // Variables globales para almacenar datos
    let userData = null;
    let currentUserId = null;

    document.addEventListener('DOMContentLoaded', () => {
        // Obtener ID de usuario de URL con manejo de errores
        try {
            if (typeof window !== 'undefined' && window.location && window.URLSearchParams) {
                const urlParams = new URLSearchParams(window.location.search);
                currentUserId = urlParams.get('id');
                console.log('ID de usuario desde URL:', currentUserId);
            }
        } catch (error) {
            console.warn('No se pudieron obtener par√°metros de URL:', error);
            currentUserId = null;
        }

        // Cargar perfil de usuario
        fetchUserProfile();

        // Listener para el bot√≥n de historial
        const historyBtn = document.getElementById('toggle-history-btn');
        if (historyBtn) {
            historyBtn.addEventListener('click', toggleHistory);
        }
    });

    async function fetchUserProfile() {
    // Verificar que tenemos un ID de usuario
    if (!currentUserId) {
        console.error('No hay ID de usuario disponible');
        document.getElementById('username-display').innerText = "Usuario no encontrado";
        return;
    }

    // Template literal - aqu√≠ se inserta el valor de currentUserId
    const url = `http://localhost:8080/api/clientes/${currentUserId}/perfil`;

    console.log('Consultando URL:', url); // Esto mostrar√°: "Consultando URL: http://localhost:8080/api/clientes/2/perfil"

    try {
        const response = await fetch(url, {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json',
            },
            credentials: 'include'
        });


            if (!response.ok) {
                throw new Error(`Error HTTP: ${response.status}`);
            }

            userData = await response.json();
            renderProfile(userData);

        } catch (error) {
            console.error('Error cargando perfil:', error);
            document.getElementById('username-display').innerText = "Error de conexi√≥n";

            // Mostrar mensaje de error m√°s espec√≠fico
            let errorMessage = "No se pudo cargar el perfil. ";
            if (error.message.includes('Failed to fetch')) {
                errorMessage += "Verifica que el backend est√© corriendo en localhost:8080.";
            } else {
                errorMessage += error.message;
            }

            alert(errorMessage);
        }
    }

    function renderProfile(data) {
        if (!data || !data.usuario) {
            console.error('Datos de usuario no v√°lidos:', data);
            return;
        }

        const usuario = data.usuario;

        try {
            // 1. Llenar Avatar y Nombre
            const usernameDisplay = document.getElementById('username-display');
            if (usernameDisplay) {
                usernameDisplay.innerText = usuario.nombre || "Usuario";
            }

            // 2. Llenar Email
            const emailInput = document.getElementById('email-input');
            if (emailInput) {
                emailInput.value = usuario.mail || "";
            }

            // 3. Llenar Rango
            const rankDisplay = document.getElementById('rank-display');
            if (rankDisplay && usuario.rango) {
                rankDisplay.innerText = usuario.rango.nombre || "Sin rango";
            }

        } catch (error) {
            console.error('Error renderizando perfil:', error);
        }
    }

    function toggleHistory() {
        const container = document.getElementById('historial-container');
        const btn = document.getElementById('toggle-history-btn');

        if (!container || !btn) {
            console.error('Elementos del historial no encontrados');
            return;
        }

        // Si est√° oculto, mostrar y renderizar
        if (container.style.display === 'none' || container.style.display === '') {
            container.style.display = 'block';
            btn.innerText = 'Ocultar historial de entradas';

            if (userData && userData.historialEntradas) {
                renderHistoryList(userData.historialEntradas);
            } else {
                container.innerHTML = '<p style="text-align:center; padding:20px;">No hay datos de historial disponibles.</p>';
            }
        } else {
            // Si est√° visible, ocultar
            container.style.display = 'none';
            btn.innerText = 'Ver historial de entradas';
        }
    }

    function renderHistoryList(historial) {
        const container = document.getElementById('historial-container');
        if (!container) return;

        container.innerHTML = ''; // Limpiar

        if (!historial || historial.length === 0) {
            container.innerHTML = '<p style="text-align:center; padding:20px;">No hay entradas registradas.</p>';
            return;
        }

        try {
            historial.forEach(entrada => {
                if (!entrada || !entrada.funcion || !entrada.butaca) {
                    console.warn('Entrada con datos incompletos:', entrada);
                    return;
                }

                const peli = entrada.funcion.pelicula;
                const funcion = entrada.funcion;
                const sala = entrada.butaca.sala;

                // Formatear fecha con manejo de errores
                let fechaStr = "Fecha no disponible";
                try {
                    if (funcion.horario) {
                        const fechaObj = new Date(funcion.horario);
                        fechaStr = fechaObj.toLocaleDateString() + ' ' + fechaObj.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                    }
                } catch (dateError) {
                    console.warn('Error formateando fecha:', dateError);
                }

                const cardHtml = `
                    <div class="ticket-card">
                        <div class="ticket-info">
                            <h4>${peli?.nombre || "Pel√≠cula no disponible"}</h4>
                            <div class="ticket-meta">
                                <i class="fas fa-calendar-alt"></i> ${fechaStr} <br>
                                <i class="fas fa-map-marker-alt"></i> ${sala?.lugar || "Lugar no disponible"} - sala ${sala?.idSala || "N/A"} - ${sala?.tipo || "Tipo no disponible"} <br>
                                <i class="fas fa-chair"></i> Fila: ${entrada.butaca.fila || "N/A"} | Col: ${entrada.butaca.columna || "N/A"}
                            </div>
                        </div>
                        <div class="ticket-price">
                            $${entrada.precio || "0"}
                        </div>
                    </div>
                `;
                container.innerHTML += cardHtml;
            });
        } catch (error) {
            console.error('Error renderizando historial:', error);
            container.innerHTML = '<p style="text-align:center; padding:20px; color: red;">Error al cargar el historial.</p>';
        }
    }
</script>

</body>
</html>